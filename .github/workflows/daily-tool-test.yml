name: Daily Tool Test Report

on:
  schedule:
    # Run daily at 06:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      iterations:
        description: 'Number of test iterations per model'
        required: false
        default: '20'
        type: string

permissions:
  contents: write

jobs:
  test-models:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Run WatsonX Tool Tests
      env:
        WATSONX_APIKEY: ${{ secrets.WATSONX_APIKEY }}
        WATSONX_PROJECT_ID: ${{ secrets.WATSONX_PROJECT_ID }}
        WATSONX_TOOL_CLIENT: watsonx
        WATSONX_TOOL_ITERATIONS: ${{ inputs.iterations || '20' }}
        WATSONX_TOOL_DEBUG: 'false'
      run: |
        # Create reports directory if it doesn't exist
        mkdir -p reports
        mkdir -p reports/history
        
        # Generate timestamp for report filename
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        
        # Generate HTML report
        HTML_REPORT_FILE="reports/tool_test_report_${TIMESTAMP}.html"
        watsonx-tool-tester test --iterations ${{ inputs.iterations || '20' }} --output "$HTML_REPORT_FILE" --html-output --save-history
        
        # Save the latest report as symlink
        ln -sf "tool_test_report_${TIMESTAMP}.html" reports/latest_report.html
        
        # Generate comprehensive 90-day report using historical data
        COMPREHENSIVE_REPORT_FILE="reports/comprehensive_report.html"
        if [ -f "reports/history/test_results.csv" ]; then
          echo "Generating comprehensive 90-day report..."
          # For now, copy the daily report as comprehensive report
          cp "$HTML_REPORT_FILE" "$COMPREHENSIVE_REPORT_FILE" || echo "Failed to create comprehensive report"
        else
          echo "No historical data available, skipping comprehensive report generation"
        fi
        
        # Create symlink for comprehensive report
        if [ -f "$COMPREHENSIVE_REPORT_FILE" ]; then
          ln -sf "comprehensive_report.html" reports/latest_comprehensive.html
          echo "COMPREHENSIVE_REPORT_FILE=$COMPREHENSIVE_REPORT_FILE" >> $GITHUB_ENV
        fi
        
        # Set environment variables for later steps
        echo "HTML_REPORT_FILE=$HTML_REPORT_FILE" >> $GITHUB_ENV
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

    - name: Upload Test Report as Artifact
      id: upload-report
      uses: actions/upload-artifact@v4
      with:
        name: tool-test-report-${{ env.TIMESTAMP }}
        path: reports/
        retention-days: 90

    - name: Commit and Push Report
      if: steps.upload-report.outcome == 'success'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add the new report
        git add reports/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Add daily tool test report - ${{ env.TIMESTAMP }}"
          git push
        fi

    - name: Update README with Latest Report Link
      if: steps.upload-report.outcome == 'success'
      run: |
        # Update README.md to include link to latest report using comment markers
        CURRENT_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        # Simple approach - just echo the new content
        if grep -q "<!-- TOOL_TEST_REPORT_START -->" README.md; then
          # Remove old section
          sed -i '/<!-- TOOL_TEST_REPORT_START -->/,/<!-- TOOL_TEST_REPORT_END -->/d' README.md
        fi
        
        # Add new section
        echo "" >> README.md
        echo "<!-- TOOL_TEST_REPORT_START -->" >> README.md
        echo "## ðŸ”§ Tool Test Status" >> README.md
        echo "" >> README.md
        echo "ðŸ“Š **[Latest Daily Report](reports/latest_report.html)** | **[90-Day Comprehensive Report](reports/latest_comprehensive.html)**" >> README.md
        echo "" >> README.md
        echo "- **Last Updated:** $CURRENT_DATE" >> README.md
        echo "- **Test Iterations:** ${{ inputs.iterations || '20' }} per model" >> README.md
        echo "- **All Reports:** [Browse Reports Directory](reports/)" >> README.md
        echo "" >> README.md
        echo "*Daily reports generated at 06:00 UTC. Comprehensive report includes 90-day trend analysis and reliability assessment.*" >> README.md
        echo "<!-- TOOL_TEST_REPORT_END -->" >> README.md

    - name: Commit README Update
      if: steps.upload-report.outcome == 'success'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add the updated README
        git add README.md
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No README changes to commit"
        else
          git commit -m "Update README with latest tool test report link - ${{ env.TIMESTAMP }}"
          git push
        fi


  cleanup-old-reports:
    runs-on: ubuntu-latest
    needs: test-models
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Clean up old reports and history
      run: |
        # Keep only the last 90 days of reports
        if [ -d "reports" ]; then
          cd reports
          # Find and remove files older than 90 days
          find . -name "tool_test_report_*.md" -type f -mtime +90 -delete
          find . -name "tool_test_report_*.html" -type f -mtime +90 -delete
          
          cd ..
          
          # Clean up old historical data (keep last 90 days)
          if command -v python3 &> /dev/null; then
            python3 -c "from watsonx_tool_tester.utils.history_manager import HistoryManager; hm = HistoryManager(); hm.cleanup_old_data(days_to_keep=90); print('Historical data cleanup completed')"
          else
            echo "Python3 not available, skipping historical data cleanup"
          fi
          
          # If any files were deleted, commit the changes
          if [ -n "$(git status --porcelain reports/)" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add reports/
            git commit -m "Clean up old test reports and historical data"
            git push
          fi
        fi
